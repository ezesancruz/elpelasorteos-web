<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de ParticipaciÃ³n</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
        }
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        h1 {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }
        input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        button {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        #result {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 4px;
            display: none; /* Oculto por defecto */
            word-wrap: break-word;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Comprobar participaciÃ³n</h1>
    <form id="verify-form">
        <input type="text" id="op_number" placeholder="Ingresa el nÃºmero de operaciÃ³n" required>
        <button type="submit">Comprobar</button>
    </form>
    <div id="result"></div>
</div>

<script>
    function formatLocalDate(isoString) {
        const date = new Date(isoString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day} / ${month} / ${year} â€“ ${hours}:${minutes} hs`;
    }

    const promoMessages = [
        'ğŸ‘‰ SeguÃ­ el canal de <a href="https://whatsapp.com/channel/0029VbBolV5A2pL9zNnhfT0n" target="_blank">WhatsApp</a> para enterarte de todas las novedades',
        'ğŸ‘€ Â¡No te lo pierdas! Seguime en <a href="https://www.tiktok.com/@_milpeso" target="_blank">TikTok</a> para ver los vivos y prÃ³ximos sorteos ğŸ¥ğŸ€',
        'ğŸ‘‰ Seguime en <a href="https://www.facebook.com/elpelaaaaaaa/" target="_blank">Facebook</a> y activÃ¡ las notificaciones ğŸ”” AsÃ­ no te perdÃ©s de nada ğŸ’¥',
        'ğŸ‘‰ EntrÃ¡ a mi <a href="https://www.instagram.com/__elpelaaa/" target="_blank">Instagram</a> y seguime ğŸ’š AhÃ­ aviso todos los sorteos, ganadores y promos ğŸ”¥'
    ];

    document.getElementById('verify-form').addEventListener('submit', async function(event) {
        event.preventDefault();

        const opNumber = document.getElementById('op_number').value;
        const resultDiv = document.getElementById('result');
        const button = document.querySelector('button');

        // Validar que no estÃ© vacÃ­o
        if (!opNumber.trim()) {
            resultDiv.textContent = 'Por favor, ingresa un nÃºmero de operaciÃ³n.';
            resultDiv.className = 'error';
            resultDiv.style.display = 'block';
            return;
        }
        
        // Mostrar estado de carga
        resultDiv.textContent = 'Comprobando...';
        resultDiv.className = '';
        resultDiv.style.display = 'block';
        button.disabled = true;

        try {
            // La URL de tu API. AsegÃºrate de que la API se estÃ© ejecutando.
            const response = await fetch(`http://127.0.0.1:8000/verificar?op=${opNumber}`);

            const data = await response.json();

            if (!response.ok) {
                // Si la API devuelve un error (ej. 422 por validaciÃ³n)
                resultDiv.textContent = data.detail ? data.detail[0].msg : 'Error al verificar. Revisa el nÃºmero ingresado.';
                resultDiv.className = 'error';
            } else {
                // Si la API devuelve una respuesta exitosa
                if (data.verified) {
                    const participantName = (data.payer_name || 'Participante').replace(/[0-9]/g, '');
                    const formattedDate = formatLocalDate(data.fecha);
                    const randomPromo = promoMessages[Math.floor(Math.random() * promoMessages.length)];
                    resultDiv.innerHTML = `ğŸ’¥ Â¡Confirmado, <strong>${participantName}</strong>, ya estÃ¡s jugando! ğŸ’ª<br>
Tu suerte estÃ¡ en marcha ğŸ€<br>
ğŸŸï¸ NÃºmero: <strong>${data.numero_operacion}</strong><br>
ğŸ¤‘ ParticipÃ¡s en la promo <strong>${data.description}</strong><br>
â° ${formattedDate}<br><br>
GuardÃ¡ tu comprobante y preparate para el vivo ğŸ”´<br><br>
${randomPromo}`;
                    resultDiv.className = 'success';
                } else {
                    resultDiv.textContent = data.mensaje || 'No se pudo verificar la participaciÃ³n.';
                    resultDiv.className = 'error';
                }
            }
        } catch (error) {
            console.error('Error:', error);
            resultDiv.textContent = 'No se pudo conectar con el servicio de verificaciÃ³n. AsegÃºrate de que la API estÃ© en funcionamiento.';
            resultDiv.className = 'error';
        } finally {
            resultDiv.style.display = 'block';
            button.disabled = false;
        }
    });
</script>

</body>
</html>
